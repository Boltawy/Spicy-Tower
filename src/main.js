import $ from"kaplay";import"kaplay/global";let k=$({debug:!0,debugKey:"t",global:!0,width:640,height:1.3*window.screen.height,letterbox:!0,stretch:!1,background:[10,10,10]});loadSprite("title","sprites/title-black.png"),loadFont("VCR_OSD","fonts/VCR_OSD_Mono.ttf"),loadSound("spicyTheme2","audio/spicy-theme2.mp3"),loadSprite("hooded","sprites/hooded.png",{sliceX:8,sliceY:9,anims:{idle1:{from:0,to:1,loop:!1,speed:4},idle2:{from:8,to:9,loop:!1,speed:4},walk:{from:16,to:19,loop:!0,speed:4},run:{from:24,to:31,loop:!0,speed:8}}}),loadSprite("startingPlatform","sprites/startingPlatform.png"),loadSprite("bg","sprites/Dungeon_brick_wall_blue.png.png"),loadSound("try-again","audio/try-again.mp3"),loadSprite("platform1","sprites/platform1.png"),loadSprite("platform2","sprites/platform2.png"),loadSprite("platform3","sprites/platform3.png"),loadSprite("platform4","sprites/platform4.png"),loadSprite("platform5","sprites/platform5.png"),loadSprite("platform6","sprites/platform6.png"),loadSprite("platform7","sprites/platform7.png"),loadSprite("platform8","sprites/platform8.png"),scene("pretitle",()=>{add([rect(width(),height()),pos(0,0),color(0,0,0),fixed(),]),isTouchscreen()?(add([text("TAP ANYWHERE",{font:"VCR_OSD",size:64}),pos(width()/2,height()/2),fixed(),anchor("center"),]),onTouchEnd(()=>{wait(.2,()=>{go("title")})})):(add([text("PRESS SPACE",{font:"VCR_OSD",size:64}),pos(width()/2,height()/2),fixed(),anchor("center"),]),onKeyPress("space",()=>{wait(.2,()=>{go("title")})}))}),k.scene("title",()=>{let $=play("spicyTheme2",{volume:1,loop:!0});function e($){for(let t=0;t<10;t++)add([sprite("bg"),pos(0,$),color(140,140,140),fixed(),move(DOWN,90),"bg",]),$-=height()-120;wait(9.5,()=>{e($)})}loadSound("track1","audio/track1.mp3"),loadSound("track2","audio/track2.mp3"),loadSound("track3","audio/track3.mp3"),loadSound("track4","audio/track4.mp3"),loadSound("track5","audio/track5.mp3"),add([sprite("bg"),pos(0,120),color(140,140,140),fixed(),"bg",]),add([sprite("bg"),pos(0,-height()+240),color(140,140,140),fixed(),"bg",]),wait(2.3,()=>{get("bg").forEach($=>{$.use(move(DOWN,90))}),e(-(2*height())+280)});let t=add([sprite("title"),pos(width()/2,height()/2-50),anchor("center"),rotate(-20),fixed(),scale(1.8),z(10),"title",]);tween(5,1.8,1.6,$=>t.scale=vec2($),easings.easeOutBounce);let o=setInterval(()=>{wait(1,()=>{isTouchscreen()?add([text("TAP TO START",{font:"VCR_OSD",size:48}),pos(width()/2,height()-100),anchor("center"),z(10),fixed(),"starttext",]):add([text("PRESS SPACE TO START",{font:"VCR_OSD",size:40}),pos(width()/2,height()-100),anchor("center"),z(10),fixed(),"starttext",])}),wait(.2,()=>{destroyAll("starttext")})},1500);onClick(()=>{destroyAll(),$?.stop(),clearInterval(o),wait(.1,()=>{k.go("game")})}),onKeyPress(["space","enter"],()=>{destroyAll("bg"),$?.stop(),clearInterval(o),wait(.1,()=>{k.go("game")})})}),k.scene("game",()=>{let $,e,t=!1,o,a;function r(){e?.stop(),$?.stop(),k.destroyAll("platform"),clearInterval(Y),k.destroyAll("wall"),clearInterval(T),k.destroyAll("bg"),clearInterval(n),a?.stop(),play("try-again",{volume:.3}),k.go("game")}loadSound("fall","audio/fall.mp3"),loadSound("pause-start","audio/pause-start.mp3"),loadSound("pause-end","audio/pause-end.mp3");let s,_=0;function l($){return t||(s=add([sprite("bg"),pos(-width()/4,$),anchor("topleft"),scale(.75),color(90,90,90),z(-1),"bg",])),s}let p=l(innerHeight/2);p=l(p.pos.y-innerHeight/1.4);let n=setInterval(()=>{!t&&p.pos.y>getCamPos().y-innerHeight&&(p=l(p.pos.y-innerHeight/1.4))},500);function i(){t||get("bg").forEach($=>{$.use(move(DOWN,.7*_))}),B&&get("bg").forEach($=>{$.unuse("move")})}add([k.text("0",{font:"VCR_OSD",size:64}),z(15),pos(width()/2,53),color(20,20,20),anchor("center"),fixed(),"score",]),add([k.text("0",{font:"VCR_OSD",size:64}),z(15),pos(width()/2+3,50),color(255,255,255),anchor("center"),fixed(),"score",]);let m=0;onUpdate(()=>{t||!W||B||(m+=Math.floor(150*dt()),get("score").forEach($=>$.text=m.toString()))}),add([sprite("startingPlatform"),scale(1.01),pos(width()/2,height()+20),anchor("center"),area(),body({isStatic:!0}),"startingPlatform",]);let f=k.make([k.pos(width()/2,height()-90),k.sprite("hooded",{anim:"idle1"}),k.body(),area({shape:new Rect(vec2(0,3),10,24)}),scale(2),anchor("center"),"player",]);add(f);let u=0,c=0;f.on("animEnd",$=>{c=rand(5,10),"idle1"===$&&u<c?(f.play("idle1"),u++):"idle1"===$&&u>=c?(f.play("idle2"),u=0):"idle2"===$&&f.play("idle1")});let d=!1,y=!1,g=!1,x=!1,h=!1;function b(){y&&d?(f.play("walk"),d=!1):g&&x?(f.play("run"),x=!1):h&&(f.play("idle1"),h=!1)}let S=!1,w=!0;function v(){!t&&w&&f.isGrounded()&&f.jump(Math.max(590,2.1*Math.abs(E)))}k.onKeyDown(["space","w","up","ص"],()=>{v()});let E=0,R=23;function O(){E>0&&(E=Math.max(E-1e3*dt(),0)),E>0&&!f.isGrounded()&&(E=Math.max(E-1e3/1.5*dt(),0)),E=Math.max(E-R*R*dt(),-1e3),S||(f.scale.x*=-1),S=!0}function C(){E<0&&(E=Math.min(E+1e3*dt(),0)),E<0&&!f.isGrounded()&&(E=Math.min(E+1e3/1.5*dt(),0)),E=Math.min(E+R*R*dt(),1e3),S&&(f.scale.x*=-1),S=!1}let D=!1,P=!1,A=!1;function V($){if(!t)for(let e=0;e<10;e++){let o=add([rect(-100,height()),pos(0,$),area(),body({isStatic:!0}),color(127,200,255),opacity(0),"wall","leftwall",]),a=add([rect(100,height()),pos(width(),$),area(),body({isStatic:!0}),color(127,200,255),opacity(0),"wall","rightwall",]);return $-=height(),o}}isTouchscreen()&&(add([polygon([vec2(50,height()-80),vec2(100,height()-130),vec2(100,height()-30),]),color(255,255,255),opacity(.1),z(10),fixed()]),add([polygon([vec2(250,height()-80),vec2(200,height()-130),vec2(200,height()-30),]),color(255,255,255),opacity(.1),z(10),fixed()]),add([pos(width()-125,height()-80),circle(45),color(255,255,255),opacity(.1),z(10),fixed()])),onTouchStart($=>{$.x>0&&$.x<100&&$.y>height()/2?(A=!0,P=!1):$.x>100&&$.x<190&&$.y>height()/2&&(P=!0,A=!1),onTouchMove($=>{$.x>0&&$.x<100&&$.y>height()/2?(A=!0,P=!1):$.x>100&&$.x<190&&$.y>height()/2&&(P=!0,A=!1)}),$.x>200&&$.x<width()&&$.y>height()/2&&(D=!0)}),onTouchEnd($=>{$.x<200?(A=!1,P=!1):$.x>200&&(D=!1)}),onUpdate(()=>{t||(isKeyDown(["d","right","ي"])||P?C():isKeyDown(["a","left","ش"])||A?O():f.isGrounded()?(E>0&&(E=Math.max(E-1e3/1.4*dt(),0)),E<0&&(E=Math.min(E+1e3/1.4*dt(),0))):(E>0&&(E=Math.max(E-1e3/3*dt(),0)),E<0&&(E=Math.min(E+1e3/3*dt(),0))),D&&v(),f.isGrounded()&&Math.abs(E)>100?y=!0:f.isGrounded()&&100>Math.abs(E)&&(y=!1,d=!0,g=!1,x=!0,h=!0),f.isGrounded()&&Math.abs(E)>100&&f.isGrounded()&&300>Math.abs(E)?y=!0:f.isGrounded()&&100>Math.abs(E)&&(y=!1,d=!0,g=!1,x=!0,h=!0),onCollide("player","wall",()=>{E=-E}),onCollideEnd("player","wall",()=>{w=!0}),b(),f.move(E,0))}),k.onKeyPress(["p","escape","ح"],()=>{t=!t,f.has("body")?f.unuse("body"):f.use(body()),t?(play("pause-start",{volume:.2}),W&&(o=e?.time(),e?.stop()),get("bg").forEach($=>{$.unuse("move")}),add([rect(width(),height()),pos(getCamPos().x-width()/2,getCamPos().y-height()/2),color(0,0,0),opacity(.5),"pauseoverlay",]),add([text("PAUSED",{font:"VCR_OSD",size:50,width:500,letterSpacing:5,align:"center"}),pos(getCamPos().x,getCamPos().y),color(255,255,255),anchor("center"),"pauseoverlay","pausetext",])):t||(play("pause-end",{volume:.2}),W&&wait(.2,()=>{e?.play(o)}),k.get("pauseoverlay").forEach($=>$.destroy()))}),k.setGravity(1400);let G=V(0),T=setInterval(()=>{t||(G.pos.y>getCamPos().y-height()&&(G=V(G.pos.y-height())),get("wall").forEach($=>{$.pos.y>getCamPos().y+500&&$.destroy()}))},500),K=200;function M($){if(!t){let e,o;for(let a=0;a<10;a++)(e=add([sprite(`platform${o=Math.floor(rand(1,9))}`),pos(width()/2,$),outline(4),scale(.9),anchor("center"),body({isStatic:!0}),"platform",`platform${o}`,])).pos.x=k.rand(K,width()-K),$-=100;return e}}let U=M(f.pos.y-60),Y=setInterval(()=>{t||(U.pos.y>getCamPos().y-height()&&(U=M(U.pos.y-100)),get("platform").forEach($=>{$.pos.y>getCamPos().y+height()/1.7&&$.destroy()}))},500);onUpdate(()=>{t||get("platform").forEach($=>{f.pos.y<$.pos.y-45&&($.is("platform1")?$.use(area({shape:new Rect(vec2(0,-10),60,1)})):$.is("platform2")?$.use(area({shape:new Rect(vec2(0,-11),123,1)})):$.is("platform3")?$.use(area({shape:new Rect(vec2(0,-13),187,1)})):$.is("platform4")?$.use(area({shape:new Rect(vec2(0,-11),251,1)})):$.is("platform5")?$.use(area({shape:new Rect(vec2(0,-12),315,1)})):$.is("platform6")?$.use(area({shape:new Rect(vec2(0,-13),378,1)})):$.is("platform7")?$.use(area({shape:new Rect(vec2(0,-18),440,1)})):$.is("platform8")&&$.use(area({shape:new Rect(vec2(0,-21),506,1)})))})}),onUpdate(()=>{t||get("platform").forEach($=>{f.pos.y>$.pos.y&&$.unuse("area")})});let j={x:width()/2,y:height()/2},B=!1,H=!0;function N(){B&&H&&(shake(20),k.play("fall",{volume:.4}),wait(1.7,()=>{onClick(()=>{r()}),onKeyPress(["space","r","R","ق","enter"],()=>{r()}),add([rect(2*width(),2*height()),pos(getCamPos().x,height()/2),color(0,0,0),anchor("center"),opacity(.5),fixed(),"gameoveroverlay",]),add([text("GAME OVER",{font:"VCR_OSD",size:90,letterSpacing:5}),pos(getCamPos().x,height()/2),anchor("center"),z(15),fixed(),"gameovertext",]),a=play("game-over",{volume:.4}),wait(2.4,()=>{isTouchscreen()?add([text("TAP to Restart",{font:"VCR_OSD",size:28}),pos(getCamPos().x,height()/2+100),anchor("center"),z(15),fixed(),"gameovertext",]):add([text("Press SPACE or R to restart",{font:"VCR_OSD",size:28}),pos(getCamPos().x,height()/2+100),anchor("center"),z(15),fixed(),"gameovertext",])})}),H=!1)}k.loadSound("game-over","audio/game-over.mp3");let W=!1,X=onUpdate(()=>{W&&(e=k.play(`track${Math.floor(k.rand(1,6))}`,{volume:.2,loop:!0}),X.cancel())});k.onUpdate(()=>{!t&&(f.pos.y>j.y+height()&&(setCamPos(j.x,j.y),B=!0,W=!1,N(),i(),e?.stop(),$?.stop()),W&&(f.pos.y<j.y-height()/3?(_=-height()/2,i(),m+=Math.floor(200*dt())):m<1250?(_=-height()/12,K=150,i()):m<3e3?(_=-height()/10,K=125,i()):m<5e3?(_=-height()/9,K=100,i()):m<7e3?(_=-height()/8.5,K=75,i()):m<9e3?(_=-height()/7.5,K=60,i()):m<12e3?(_=-height()/7,i()):m<16e3?(_=-height()/6.5,i()):m<2e4?(_=-height()/6,i()):(_=-height()/5.5,i()),m>9e3&&(K=50),setCamPos(j.x,j.y),j.y+=_*dt()),f.pos.y<height()/2&&(W=!0))}),onKeyPress(";",()=>{r()})}),go("pretitle");